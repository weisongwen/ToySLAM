<!-- Save as uwb_imu_fusion.launch -->
<launch>
    <node name="uwb_imu_batch_node" pkg="ToySLAM" type="uwb_imu_batch_node" output="screen" > 
        <!-- Enable simulation time -->
        <param name="use_sim_time" value="true"/>
        
        <!-- IMU and Sensor Parameters -->
        <param name="gravity_magnitude" value="9.81"/>
        <param name="imu_acc_noise" value="0.03"/>        <!-- m/s² -->
        <param name="imu_gyro_noise" value="0.002"/>      <!-- rad/s -->
        <param name="imu_acc_bias_noise" value="0.0001"/> <!-- m/s²/sqrt(s) -->
        <param name="imu_gyro_bias_noise" value="0.00001"/> <!-- rad/s/sqrt(s) -->
        <param name="acc_bias_max" value="0.1"/>          <!-- Maximum allowed acc bias (m/s²) -->
        <param name="gyro_bias_max" value="0.01"/>        <!-- Maximum allowed gyro bias (rad/s) -->
        <param name="initial_acc_bias_x" value="0.05"/>   <!-- Initial accelerometer bias -->
        <param name="initial_acc_bias_y" value="-0.05"/>
        <param name="initial_acc_bias_z" value="0.05"/>
        <param name="initial_gyro_bias_x" value="0.001"/> <!-- Initial gyroscope bias -->
        <param name="initial_gyro_bias_y" value="-0.001"/>
        <param name="initial_gyro_bias_z" value="0.001"/>
        <param name="uwb_position_noise" value="0.05"/>   <!-- m -->
        
        <!-- Optimization Parameters -->
        <param name="optimization_window_size" value="20"/>  <!-- Number of keyframes in sliding window -->
        <param name="optimization_frequency" value="10.0"/>  <!-- Hz -->
        <param name="imu_buffer_time_length" value="10.0"/>  <!-- seconds -->
        <param name="max_iterations" value="10"/>           <!-- Max optimization iterations -->
        
        <!-- Feature Enablement -->
        <param name="enable_bias_estimation" value="true"/>  <!-- Enable IMU bias estimation -->
        <param name="enable_marginalization" value="true"/>  <!-- Enable marginalization -->
        <param name="enable_roll_pitch_constraint" value="true"/> <!-- Enable roll/pitch constraint -->
        <param name="enable_gravity_alignment_factor" value="true"/> <!-- Enable gravity alignment factor -->
        <param name="enable_orientation_smoothness_factor" value="true"/> <!-- Enable orientation smoothness -->
        <param name="enable_velocity_constraint" value="true"/> <!-- Enable velocity constraint -->
        <param name="enable_horizontal_velocity_incentive" value="false"/> <!-- Enable horizontal velocity incentive -->
        <param name="enable_imu_orientation_factor" value="true"/> <!-- Enable IMU orientation factor -->
        
        <!-- Frame IDs -->
        <param name="world_frame_id" value="map"/>
        <param name="body_frame_id" value="base_link"/>
        
        <!-- Constraint Weights -->
        <param name="roll_pitch_weight" value="300.0"/>     <!-- Roll/pitch prior factor weight -->
        <param name="max_imu_dt" value="0.5"/>              <!-- Maximum IMU time step (s) -->
        <param name="imu_orientation_weight" value="50.0"/> <!-- IMU orientation factor weight -->
        <param name="bias_constraint_weight" value="1000.0"/> <!-- Bias magnitude constraint weight -->
        <param name="max_velocity" value="2.0"/>            <!-- Maximum allowed velocity (m/s) -->
        <param name="velocity_constraint_weight" value="200.0"/> <!-- Velocity constraint weight -->
        <param name="min_horizontal_velocity" value="0.3"/> <!-- Minimum desired horizontal velocity -->
        <param name="horizontal_velocity_weight" value="20.0"/> <!-- Horizontal velocity incentive weight -->
        <param name="orientation_smoothness_weight" value="150.0"/> <!-- Orientation smoothness weight -->
        <param name="gravity_alignment_weight" value="200.0"/>     <!-- Gravity alignment constraint weight -->
        
        <!-- RK4 Integration Parameters -->
        <param name="max_integration_dt" value="0.01"/>     <!-- Maximum step size for RK4 integration -->
        <param name="min_integration_dt" value="1e-8"/>     <!-- Minimum step size for integration -->
        <param name="bias_correction_threshold" value="0.05"/> <!-- Threshold for bias validity check -->
    </node>
    
    <!-- Add rostopic echo for debugging -->
    <!-- <node name="imu_echo" pkg="rostopic" type="rostopic" args="echo /sensor_simulator/imu_data" output="screen"/>
    <node name="uwb_echo" pkg="rostopic" type="rostopic" args="echo /sensor_simulator/UWBPoistionPS" output="screen"/> -->
</launch>